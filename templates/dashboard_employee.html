{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}

<!-- 1. BÖLÜM: UYARI SİSTEMİ -->
{% if alerts %}
<div class="row mb-4">
    <div class="col-12">
        {% for alert in alerts %}
        <div class="alert alert-{{ alert.type }} alert-dismissible fade show d-flex align-items-center shadow-sm border-0" role="alert">
            <i class="fas {% if alert.type == 'danger' %}fa-exclamation-circle text-danger{% else %}fa-clock text-warning{% endif %} me-3 fa-lg"></i>
            <div>
                <strong>{{ alert.msg }}</strong> "{{ alert.task.title }}" görevinin tamamlanma tarihi: {{ alert.task.due_date }}
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- ÜST BAŞLIK VE BUTONLAR -->
<div class="row mb-4 align-items-center">
    <div class="col-md-8">
        <h2 class="fw-bold"><i class="fas fa-user-tie text-primary me-2"></i> {{ page_title }}</h2>
        <p class="text-muted mb-0">Kendi görevleriniz, ortak işleriniz ve ekip arkadaşlarınızın durumu.</p>
    </div>
    <div class="col-md-4 text-end">
        <button type="button" class="btn btn-outline-info me-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#todayTasksModal">
            <i class="fas fa-calendar-day"></i> Bugünün İşleri
        </button>
        <a href="{% url 'create_task' %}" class="btn btn-primary shadow-sm">
            <i class="fas fa-plus-circle"></i> Yeni Görev Oluştur
        </a>
    </div>
</div>

<!-- 2. BÖLÜM: KENDİ GÖREVLERİM TABLOSU -->
<div class="card shadow-sm mb-5 border-0">
    <div class="card-header bg-white py-3 border-bottom">
        <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-clipboard-list text-primary me-2"></i> Aktif Görevlerim ve Ortaklıklar</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                        <th class="ps-4">İş Tanımı</th>
                        <th>Öncelik</th>
                        <th>Son Tarih</th>
                        <th>Durum</th>
                        <th class="text-end pe-4">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-dark">{{ task.title }}</div>
                            <small class="text-muted">
                                {% if task.assigned_to == user %}
                                <i class="fas fa-user-check text-success me-1"></i> Sorumlusunuz
                                {% else %}
                                <i class="fas fa-user-friends text-info me-1"></i> İş Ortağısınız
                                {% endif %}
                            </small>
                        </td>
                        <td>
                            <span class="badge bg-{% if task.priority == 'yuksek' %}danger{% elif task.priority == 'orta' %}warning{% else %}success{% endif %}">{{ task.get_priority_display }}</span>
                        </td>
                        <td>
                            <span class="{% if task.due_date < today %}text-danger fw-bold{% endif %}">
                                {{ task.due_date|date:"d M Y" }}
                            </span>
                        </td>
                        <td><span class="badge bg-secondary-subtle text-secondary border">{{ task.get_status_display }}</span></td>
                        <td class="text-end pe-4">
                            <a href="{% url 'task_detail' task.pk %}" class="btn btn-sm btn-primary px-3">Detay / Güncelle</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted fst-italic">Aktif bir göreviniz bulunmuyor.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 3. BÖLÜM: OPTİMİZE EDİLMİŞ İŞ YÜKÜ GRAFİĞİ -->
<div class="card shadow-sm border-0 mb-5">
    <div class="card-header bg-white border-bottom py-3 px-4">
        <div class="row align-items-center">
            <div class="col-lg-3 mb-2 mb-lg-0">
                <h5 class="mb-0 fw-bold"><i class="fas fa-chart-line text-info me-2"></i>İş Yükü</h5>
                <small class="text-muted">Planlama ve Analiz</small>
            </div>
            
            <div class="col-lg-9 text-lg-end">
                <div class="d-flex flex-wrap justify-content-lg-end gap-3 align-items-center">
                    
                    <!-- ALGORİTMA SEÇİCİ -->
                    <form method="get" class="d-inline-block">
                        <input type="hidden" name="range" value="{{ current_range|default:'month' }}">
                        <input type="hidden" name="start" value="{{ start_date_val }}">
                        <input type="hidden" name="end" value="{{ end_date_val }}">
                        
                        <span class="small fw-bold text-muted me-1">STRATEJİ:</span>
                        <div class="btn-group btn-group-sm shadow-sm">
                            <button type="submit" name="strategy" value="balanced" class="btn btn-outline-primary {% if current_strategy == 'balanced' or not current_strategy %}active{% endif %}">Dengeli</button>
                            <button type="submit" name="strategy" value="priority_weighted" class="btn btn-outline-primary {% if current_strategy == 'priority_weighted' %}active{% endif %}">Öncelik</button>
                            <button type="submit" name="strategy" value="size_weighted" class="btn btn-outline-primary {% if current_strategy == 'size_weighted' %}active{% endif %}">Büyüklük</button>
                            <button type="submit" name="strategy" value="deadline_weighted" class="btn btn-outline-primary {% if current_strategy == 'deadline_weighted' %}active{% endif %}">Vade</button>
                        </div>
                    </form>

                    <!-- TARİH ARALIĞI SEÇİCİ (ÖZEL TARİH DAHİL) -->
                    <form method="get" class="d-inline-flex align-items-center bg-light rounded p-1 border">
                        <input type="hidden" name="strategy" value="{{ current_strategy|default:'balanced' }}">
                        
                        <!-- Hazır Aralıklar -->
                        <div class="btn-group btn-group-sm me-2">
                            <button type="submit" name="range" value="week" class="btn btn-outline-secondary bg-white text-dark {% if current_range == 'week' %}active{% endif %}">Hafta</button>
                            <button type="submit" name="range" value="month" class="btn btn-outline-secondary bg-white text-dark {% if current_range == 'month' or not current_range %}active{% endif %}">Ay</button>
                            <button type="submit" name="range" value="year" class="btn btn-outline-secondary bg-white text-dark {% if current_range == 'year' %}active{% endif %}">Yıl</button>
                        </div>

                        <!-- Özel Tarih Seçici -->
                        <div class="input-group input-group-sm">
                            <input type="date" name="start" class="form-control form-control-sm border-0 ps-1 pe-1" value="{{ start_date_val }}" required style="width: 110px;">
                            <span class="input-group-text border-0 bg-transparent px-0">-</span>
                            <input type="date" name="end" class="form-control form-control-sm border-0 ps-1 pe-1" value="{{ end_date_val }}" required style="width: 110px;">
                            <button type="submit" name="range" value="custom" class="btn btn-primary btn-sm rounded-end" title="Filtrele">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div style="height: 350px;">
            <canvas id="workloadChart"></canvas>
        </div>
        <div class="alert alert-light mt-3 mb-0 small border-0 text-muted">
            <i class="fas fa-info-circle me-1"></i> 
            <strong>{{ current_strategy|default:"Dengeli"|title }} Dağılım</strong> - 
            {{ start_date_val }} ile {{ end_date_val }} arasındaki iş yükü görüntüleniyor.
            (8 saati aşan günler <span class="text-danger fw-bold">kırmızı</span> işaretlenir).
        </div>
    </div>
</div>

<!-- 4. BÖLÜM: EKİP ARKADAŞLARININ GÖREVLERİ (SADECE GÖRÜNTÜLEME) -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-light py-3 border-bottom">
        <h5 class="mb-0 fw-bold text-secondary"><i class="fas fa-users me-2"></i> Ekip Arkadaşlarının Mevcut İşleri</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
                <thead class="bg-white text-muted small text-uppercase">
                    <tr>
                        <th class="ps-4">Çalışan</th>
                        <th>İş Tanımı</th>
                        <th>Durum</th>
                        <th class="text-end pe-4">Görüntüle</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t_task in teammate_tasks %}
                    <tr>
                        <td class="ps-4 text-dark">
                            <i class="fas fa-user-circle text-muted me-1"></i> 
                            {{ t_task.assigned_to.get_full_name|default:t_task.assigned_to.username }}
                        </td>
                        <td>{{ t_task.title }}</td>
                        <td><span class="badge bg-light text-dark border">{{ t_task.get_status_display }}</span></td>
                        <td class="text-end pe-4">
                            <a href="{% url 'task_detail' t_task.pk %}" class="btn btn-sm btn-link text-decoration-none">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center py-4 text-muted">Ekipte başka aktif iş bulunamadı.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- POP-UP MODAL: BUGÜNÜN İŞ LİSTESİ -->
<div class="modal fade" id="todayTasksModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title"><i class="fas fa-calendar-check me-2"></i>Bugün Yapılacaklar</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                {% if today_tasks %}
                <p class="text-muted small mb-3">Bugün ({{ today|date:"d F" }}) ilgilenmeniz gereken görevler:</p>
                <div class="list-group list-group-flush">
                    {% for t_task in today_tasks %}
                    <div class="list-group-item px-0 border-0 mb-2">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h6 class="mb-1 fw-bold text-dark">{{ t_task.title }}</h6>
                            <span class="badge bg-info-subtle text-info border border-info">{{ t_task.get_priority_display }}</span>
                        </div>
                        <p class="mb-1 small text-muted">{{ t_task.description|truncatechars:80 }}</p>
                        <a href="{% url 'task_detail' t_task.pk %}" class="text-primary small fw-bold text-decoration-none">Detaya Git &rarr;</a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-mug-hot fa-3x text-secondary opacity-25 mb-3"></i>
                    <p class="text-muted">Bugün için planlanmış bir işiniz görünmüyor.</p>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- VERİ AKTARIMI -->
{{ chart_labels|json_script:"chart-labels-data" }}
{{ chart_data|json_script:"chart-data-source" }}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. POP-UP OTOMATİK AÇMA
        {% if today_tasks %}
            if (!sessionStorage.getItem('todayTasksShown')) {
                const todayModalElement = document.getElementById('todayTasksModal');
                if (todayModalElement) {
                    const todayModal = new bootstrap.Modal(todayModalElement);
                    todayModal.show();
                    sessionStorage.setItem('todayTasksShown', 'true');
                }
            }
        {% endif %}

        // 2. GRAFİK ÇİZİMİ
        const labelsData = document.getElementById('chart-labels-data');
        const sourceData = document.getElementById('chart-data-source');

        if (labelsData && sourceData) {
            const labels = JSON.parse(labelsData.textContent);
            const data = JSON.parse(sourceData.textContent);
            const ctxCanvas = document.getElementById('workloadChart');

            if (!labels || labels.length === 0) {
                if (ctxCanvas && ctxCanvas.parentElement) {
                    ctxCanvas.parentElement.innerHTML = `
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <p><i class="fas fa-info-circle me-2"></i>İş yükü grafiği için veri bulunamadı.</p>
                        </div>`;
                }
                return;
            }

            const ctx = ctxCanvas.getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Günlük Planlanan Saat',
                        data: data,
                        backgroundColor: data.map(v => v > 8 ? 'rgba(255, 99, 132, 0.7)' : 'rgba(54, 162, 235, 0.6)'),
                        borderColor: data.map(v => v > 8 ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)'),
                        borderWidth: 1.5,
                        borderRadius: 5,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Planlanan: ${context.raw} Saat`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            // OTO ÖLÇEK İÇİN SUGGESTED MAX KALDIRILDI
                            title: { display: true, text: 'Saat / Gün' },
                            grid: { color: '#f0f0f0' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}